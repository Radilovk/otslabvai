# GitHub API Token Configuration

## Общо описание

Този функционал позволява съхранение на GitHub Personal Access Token в Cloudflare KV хранилището, за да се използва автоматично от админ панела при качване на изображения, вместо да се иска от потребителя всеки път.

## Как работи

1. **API Token се съхранява в KV**: Токенът се записва в KV хранилището с ключ `api_token`
2. **Admin панелът извлича токена**: При опит за качване на изображение, `admin.js` първо проверява дали има токен в sessionStorage, след това го извлича от backend API
3. **Fallback на prompt**: Ако токенът не е конфигуриран или е невалиден, потребителят все още може да го въведе ръчно

## Стъпки за конфигуриране

### 1. Генериране на GitHub Personal Access Token

1. Отидете на GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Кликнете "Generate new token (classic)"
3. Дайте име на токена (например: "otslabvai-image-upload")
4. Изберете scope: **`repo`** (пълен достъп до repositories)
5. Генерирайте токена и копирайте го
6. **ВАЖНО**: Запазете токена на сигурно място - не може да бъде видян отново

### 2. Задаване на токена в KV

Има два начина да зададете токена:

#### Опция А: Използване на скрипта (препоръчително)

```bash
./set-api-token.sh
```

Скриптът ще ви подкани да въведете токена безопасно (без да се показва на екрана).

Или директно с аргумент:
```bash
./set-api-token.sh ghp_YourTokenHere123456789
```

#### Опция Б: Използване на wrangler директно

```bash
echo "your_github_token_here" | wrangler kv:key put --binding="PAGE_CONTENT" "api_token" --path=-
```

### 3. Проверка

След като сте задали токена:
1. Отворете админ панела (`/admin.html`)
2. Отидете на "Съдържание" таб
3. Редактирайте продукт и опитайте да качите изображение
4. Изображението трябва да се качи **без да ви се иска токен**

## API Документация

### GET /api-token

Връща съхранения GitHub API token от KV.

**Response:**
```json
{
  "api_token": "ghp_YourTokenHere..." или null
}
```

## Промени в кода

### worker.js
- Добавен нов endpoint `/api-token` за извличане на токена
- Функция `handleGetApiToken()` за обработка на заявката

### admin.js
- Актуализирана функция `uploadImageToGitHub()`:
  1. Проверява sessionStorage
  2. Ако няма токен там, извлича от backend API
  3. Кеширва токена в sessionStorage
  4. Fallback на prompt ако не е налице

### set-api-token.sh (НОВ)
- Скрипт за лесно задаване на токена в KV

## Сигурност

- Токенът се съхранява в Cloudflare KV (сигурно облачно хранилище)
- Токенът се връща само през backend API (не е видим в frontend кода)
- sessionStorage кеширане намалява API заявките
- При невалиден токен (401/403 грешка), sessionStorage се изчиства автоматично

## Съвети за използване

1. **Редовна ротация**: Сменяйте токена периодично за по-добра сигурност
2. **Минимални права**: Използвайте токен само с `repo` права, без допълнителни scopes
3. **Monitoring**: Проверявайте GitHub audit log за неочаквана активност
4. **Backup**: Запазете токена на сигурно място (password manager)

## Troubleshooting

### Токенът не работи
- Проверете дали токенът има `repo` permissions
- Проверете дали токенът не е изтекъл
- Опитайте да го зададете отново с `./set-api-token.sh`

### Все още се иска токен
- Изчистете sessionStorage в браузъра (Developer Tools → Application → Session Storage)
- Презаредете страницата
- Проверете дали токенът е правилно записан в KV:
  ```bash
  wrangler kv:key get --binding="PAGE_CONTENT" "api_token"
  ```

### API грешка 401/403
- Токенът е невалиден или е изтекъл
- Генерирайте нов токен и го задайте отново
